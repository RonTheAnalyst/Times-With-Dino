<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dino Math: 3-Step Master</title>
    <style>
        :root {
            --primary: #673AB7; 
            --accent: #FFEB3B; 
            --highlight: #FF5722; 
            --success: #4CAF50;
            --error: #F44336;
            --bg: #F3E5F5;
        }
        
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 10px;
            overflow: hidden;
            user-select: none; 
        }

        /* --- Header --- */
        .header {
            background: white;
            padding: 12px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 10;
        }

        select {
            padding: 8px 12px;
            font-size: 1.1rem;
            border-radius: 8px;
            border: 2px solid var(--primary);
            font-weight: bold;
            color: var(--primary);
        }

        /* --- The Quiz Input --- */
        .quiz-input {
            width: 80px;
            padding: 8px;
            font-size: 1.2rem;
            text-align: center;
            border: 3px solid #ccc;
            border-radius: 8px;
            display: none; 
            font-weight: bold;
            color: #333;
        }
        .quiz-input.visible { display: block; border-color: var(--highlight); }
        .quiz-input.error { border-color: var(--error); color: var(--error); animation: shake 0.3s; }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* --- Main Visualization Area --- */
        .math-container {
            background: white;
            width: 95%;
            max-width: 800px;
            flex-grow: 1;
            border-radius: 20px;
            padding: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            overflow-y: auto;
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
        }

        /* --- Bubbles --- */
        .math-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px 20px;
            background: #fff;
            border: 3px solid var(--highlight); 
            border-radius: 50px; 
            white-space: nowrap;
            transition: all 0.3s;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.05);
        }

        .dino-icon {
            font-size: 2rem;
            display: inline-block;
            margin: 0 2px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Step 2: Row Counts */
        .row-equals, .plus-separator {
            opacity: 0; 
            transition: opacity 0.5s ease;
        }
        .row-equals { font-size: 1.5rem; color: #888; margin-left: 20px; font-weight: bold; }
        .plus-separator { font-size: 2rem; color: var(--primary); font-weight: bold; margin-left: 30px; line-height: 0.5; height: 20px; }
        
        .visible-step-2 { opacity: 1 !important; }

        /* Step 3: Total */
        .total-line { 
            border-top: 3px solid #333; width: 90%; margin-top: 15px; padding-top: 10px; 
            font-size: 2rem; color: var(--primary); font-weight: bold; padding-left: 20px; 
            opacity: 0; transition: opacity 0.5s ease;
        }
        .visible-step-3 { opacity: 1 !important; }

        /* --- Footer --- */
        .footer {
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 10px 20px;
            position: relative;
            flex-shrink: 0;
            border-top: 4px solid var(--primary);
        }

        .number-line-scroll { overflow-x: auto; padding-top: 50px; padding-bottom: 20px; }
        .number-line { position: relative; height: 3px; background: #333; }
        .tick { position: absolute; bottom: 0; width: 2px; height: 10px; background: #999; }
        .tick-label { position: absolute; bottom: -25px; transform: translateX(-50%); font-size: 0.8rem; color: #666; }
        .tick-label.highlight { color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        #flyingDino {
            position: absolute; top: -45px; left: -10px; font-size: 2.5rem;
            transition: left 1s ease-in-out; z-index: 50;
        }
        .flying { animation: flyArc 1s ease-in-out; }
        @keyframes flyArc { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-60px) rotate(-15deg); } 100% { transform: translateY(0) rotate(0deg); } }

        /* --- Button --- */
        #nextBtn {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 30px; font-size: 1.3rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #4527A0; transition: transform 0.1s;
        }
        #nextBtn:active { transform: translateY(4px); box-shadow: none; }
        #nextBtn.info-mode { background: #03A9F4; box-shadow: 0 4px 0 #0277BD; } /* Blue for Info */
        #nextBtn.check-mode { background: var(--success); box-shadow: 0 4px 0 #2E7D32; }
        
        /* Volume Toggle */
        .sound-toggle {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            opacity: 0.5;
        }
        .sound-toggle:hover { opacity: 1; }

    </style>
</head>
<body>

    <button class="sound-toggle" onclick="toggleSound()" id="soundBtn">ðŸ”Š</button>

    <div class="header">
        <label>Times Table of:</label>
        <select id="tableSelect" onchange="resetGame()"></select>
        
        <input type="number" id="guessInput" class="quiz-input" placeholder="Sum?">
        
        <button id="nextBtn" onclick="handleGameStep()">Start</button>
    </div>

    <div class="math-container" id="mathArea">
        <div style="color: #999; padding: 20px;">Select a number to begin...</div>
    </div>

    <div class="footer">
        <div class="number-line-scroll" id="scrollContainer">
            <div class="number-line" id="numberLine">
                <div id="flyingDino">ðŸ¦–</div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let tableNum = 4;
        let multiplier = 0;
        let maxMultiplier = 10;
        
        // PHASES: 'START_ROUND' -> 'SHOW_COUNTS' -> 'CHECK_ANSWER'
        let phase = 'START_ROUND'; 
        
        const tickSpacing = 35;
        let soundEnabled = true;

        // --- DOM ---
        const mathArea = document.getElementById('mathArea');
        const numLine = document.getElementById('numberLine');
        const select = document.getElementById('tableSelect');
        const btn = document.getElementById('nextBtn');
        const guessInput = document.getElementById('guessInput');
        const scrollContainer = document.getElementById('scrollContainer');

        // Init Dropdown
        for(let i=1; i<=10; i++){
            let opt = document.createElement('option');
            opt.value = i; opt.innerText = i;
            if(i===4) opt.selected = true;
            select.appendChild(opt);
        }

        // Enter Key
        guessInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") handleGameStep();
        });

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            if (!soundEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function playSound(effect) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if (effect === 'pop') playTone(600, 'sine', 0.1);
            else if (effect === 'reveal') playTone(800, 'sine', 0.1); // Higher pitch for reveal
            else if (effect === 'success') { playTone(523.25, 'triangle', 0.2); setTimeout(() => playTone(659.25, 'triangle', 0.4), 100); }
            else if (effect === 'error') playTone(150, 'sawtooth', 0.3);
        }
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundBtn').innerText = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
        }

        // --- Logic ---
        function resetGame() {
            tableNum = parseInt(select.value);
            multiplier = 0;
            phase = 'START_ROUND';
            
            mathArea.innerHTML = '<div style="color: #888; padding:20px;">Ready! Click Start.</div>';
            btn.innerText = "Start (x1)";
            btn.className = "";
            guessInput.classList.remove('visible');
            
            drawNumberLine();
            moveDino(0, false);
        }

        function drawNumberLine() {
            let maxVal = tableNum * 10; 
            numLine.style.width = (maxVal * tickSpacing + 100) + 'px';
            numLine.innerHTML = '<div id="flyingDino">ðŸ¦–</div>';
            for(let i=0; i<=maxVal; i++) {
                let tick = document.createElement('div');
                tick.className = 'tick'; tick.style.left = (i * tickSpacing) + 'px';
                let label = document.createElement('div');
                label.className = 'tick-label'; label.innerText = i; label.id = `label-${i}`;
                label.style.left = (i * tickSpacing) + 'px';
                numLine.appendChild(label); numLine.appendChild(tick);
            }
        }

        function handleGameStep() {
            
            // --- PHASE 1: START ROUND (Show Grid) ---
            if(phase === 'START_ROUND') {
                if(multiplier >= maxMultiplier) {
                    if(confirm("Reset?")) resetGame(); return;
                }
                multiplier++; 
                
                // 1. Render Visuals (Images Only)
                renderGrid(false, false); 
                playSound('pop');
                
                // Update State -> Prepare to Show Counts
                phase = 'SHOW_COUNTS';
                btn.innerText = "Show Numbers";
                btn.className = "info-mode"; // Blue button
                
                mathArea.scrollTop = mathArea.scrollHeight;
                return;
            }

            // --- PHASE 2: SHOW COUNTS (Scaffolding) ---
            if(phase === 'SHOW_COUNTS') {
                // 2. Reveal Row Counts (= 4)
                revealCounts();
                playSound('reveal');

                // Show Quiz Input for Final Step
                guessInput.value = '';
                guessInput.classList.add('visible');
                guessInput.focus();

                // Update State -> Prepare to Check
                phase = 'CHECK_ANSWER';
                btn.innerText = "Check Total";
                btn.className = "check-mode"; // Green button
                return;
            }

            // --- PHASE 3: CHECK ANSWER (Solution) ---
            if(phase === 'CHECK_ANSWER') {
                let correctAnswer = tableNum * multiplier;
                let userGuess = parseInt(guessInput.value);

                if(userGuess === correctAnswer) {
                    // Success!
                    playSound('success');
                    revealTotal(); // Show Total Line
                    moveDino(correctAnswer, true); // Fly
                    document.getElementById(`label-${correctAnswer}`).classList.add('highlight');
                    
                    guessInput.classList.remove('visible');
                    
                    // Reset Logic for Next Round
                    phase = 'START_ROUND';
                    if(multiplier < maxMultiplier) {
                        btn.innerText = `Next (x${multiplier + 1})`;
                    } else {
                        btn.innerText = "Finish";
                    }
                    btn.className = "";
                } else {
                    // Fail
                    playSound('error');
                    guessInput.classList.add('error');
                    setTimeout(() => guessInput.classList.remove('error'), 300);
                }
            }
        }

        function renderGrid() {
            mathArea.innerHTML = ''; 
            for(let r = 0; r < tableNum; r++) {
                let rowDiv = document.createElement('div');
                rowDiv.className = 'math-row';
                for(let c = 0; c < multiplier; c++) {
                    let dino = document.createElement('span');
                    dino.className = 'dino-icon'; dino.innerText = 'ðŸ¦–';
                    rowDiv.appendChild(dino);
                }
                // Step 2 Element (Hidden initially)
                let equals = document.createElement('span');
                equals.className = 'row-equals';
                equals.innerText = `= ${multiplier}`;
                rowDiv.appendChild(equals);
                mathArea.appendChild(rowDiv);

                if(r < tableNum - 1) {
                    let plusDiv = document.createElement('div');
                    plusDiv.className = 'plus-separator';
                    plusDiv.innerText = '+'; mathArea.appendChild(plusDiv);
                }
            }
            // Step 3 Element (Hidden initially)
            let totalDiv = document.createElement('div');
            totalDiv.className = 'total-line';
            totalDiv.innerText = `Total: ${tableNum * multiplier}`;
            mathArea.appendChild(totalDiv);
            mathArea.scrollTop = mathArea.scrollHeight;
        }

        function revealCounts() {
            // Adds class to reveal Step 2 elements
            document.querySelectorAll('.row-equals').forEach(el => el.classList.add('visible-step-2'));
            document.querySelectorAll('.plus-separator').forEach(el => el.classList.add('visible-step-2'));
        }

        function revealTotal() {
            // Adds class to reveal Step 3 elements
            document.querySelectorAll('.total-line').forEach(el => el.classList.add('visible-step-3'));
        }

        function moveDino(targetVal, animate) {
            const d = document.getElementById('flyingDino');
            let px = targetVal * tickSpacing;
            d.style.left = (px - 15) + 'px'; 
            if(animate) {
                d.classList.remove('flying'); void d.offsetWidth; d.classList.add('flying');
            }
            let containerCenter = scrollContainer.clientWidth / 2;
            scrollContainer.scrollTo({ left: px - containerCenter, behavior: 'smooth' });
        }

        window.onload = resetGame;
    </script>
</body>
</html>
